<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>simpla-text</title>
    <script src="../../webcomponentsjs/webcomponents-lite.min.js"></script>
    <script src="../../web-component-tester/browser.js"></script>

    <!-- Test Helpers -->
    <link rel="import" href="../../iron-test-helpers/iron-test-helpers.html">
    <link rel="import" href="./test-setup.html">

    <!-- Import the element to test -->
    <link rel="import" href="../simpla-text.html">

  </head>
  <body>
    <test-fixture id="simple">
      <template>
        <simpla-text></simpla-text>
      </template>
    </test-fixture>
    <test-fixture id="declared-editable">
      <template>
        <simpla-text editable></simpla-text>
      </template>
    </test-fixture>
    <script>
      describe('simpla connector', () => {
        let path = '/test-path',
            component;

        beforeEach(function() {
          component = fixture('simple');
          component.path = path;
          return flushEditor(component);
        });

        afterEach(function() {
          return Simpla.remove(path);
        });

        describe('editable', () => {
          it('should be bound to Simplas editable state', () => {
            Simpla.editable(true);
            expect(component.editable).to.be.true;

            Simpla.editable(false);
            expect(component.editable).to.be.false;
          });

          it('should prefer declarative over Simplas state', () => {
            let component;

            Simpla.editable(false);
            component = fixture('declared-editable');
            expect(component.editable).to.be.true;
          });

          it('should follow Simpla on attach', () => {
            let component;

            Simpla.editable(true);
            component = fixture('simple');
            expect(component.editable).to.be.true;
          });
        });

        describe('data', () => {
          const setContentAndWait = text => () => {
            return Simpla.set(path, {
              type: 'Text',
              data: { text }
            }).then(wait());
          };

          it('should observe data thats stored in the state on attach', () => {
            return Promise.resolve()
              .then(setContentAndWait('Hello World'))
              .then(() => {
                expect(component.value).to.match(/>?Hello World<?/);
              })
              .then(setContentAndWait('Hello World, again'))
              .then(() => {
                expect(component.value).to.match(/>?Hello World, again<?/);
              });
          });

          it('while editing, it should update data in the state', () => {
            component.editable = true;

            return flushEditor(component)
              .then(() => {
                component.value = 'Hello World';
              })
              .then(wait())
              .then(() => Simpla.get(path))
              .then((response) => {
                expect(response).to.be.ok;
                expect(response.data.text).to.match(/Hello World/);
              });
          });

          it('should fire a `contentload` event each time new content is loaded', () => {
            let spy = sinon.spy();

            component.addEventListener('contentload', spy);

            return Promise.resolve()
              .then(setContentAndWait('some content'))
              .then(() => {
                expect(spy.callCount).to.equal(1);
              })
              .then(setContentAndWait('more content'))
              .then(() => {
                expect(spy.callCount).to.equal(2);
              });
          });
        });
      });
    </script>
  </body>
</html>
